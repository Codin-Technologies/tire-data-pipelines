services:
  # ----------------------------------------------------------
  # Apache NiFi
  # ----------------------------------------------------------
  nifi:
    image: apache/nifi:1.25.0
    ports:
      - "8443:8443"
    environment:
      NIFI_WEB_HTTPS_PORT: 8443
      NIFI_SECURITY_USER_LOGIN_IDENTITY_PROVIDER: single-user
      NIFI_SECURITY_USER_AUTHORIZER: single-user-authorizer
      NIFI_SINGLE_USER_CREDENTIALS_USERNAME: admin
      NIFI_SINGLE_USER_CREDENTIALS_PASSWORD: admin123
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./nifi_data:/opt/nifi/nifi-current/data
    healthcheck:
      test: [ "CMD", "curl", "-fk", "https://localhost:8443/nifi" ]
      interval: 30s
      timeout: 10s
      retries: 5

  # ----------------------------------------------------------
  # ZooKeeper
  # ----------------------------------------------------------
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    ports:
      - "2181:2181"
    healthcheck:
      test: [ "CMD", "echo", "ruok", "|", "nc", "localhost", "2181" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------
  # Kafka Broker
  # ----------------------------------------------------------
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: [ "CMD", "bash", "-c", "echo > /dev/tcp/localhost/9092" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------
  # Kafka UI
  # ----------------------------------------------------------
  kafdrop:
    image: obsidiandynamics/kafdrop
    ports:
      - "9004:9000"
    environment:
      KAFKA_BROKERCONNECT: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy

  # ----------------------------------------------------------
  # Flink Cluster
  # ----------------------------------------------------------
  flink-jobmanager:
    build: ./flink-python
    container_name: flink-jobmanager
    ports:
      - "8082:8081"
    environment:
      JOB_MANAGER_RPC_ADDRESS: flink-jobmanager
    command: jobmanager
    depends_on:
      kafka:
        condition: service_healthy

  flink-taskmanager:
    build: ./flink-python
    container_name: flink-taskmanager
    depends_on:
      - flink-jobmanager
      - kafka
    command: taskmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 4
        taskmanager.memory.process.size: 2048m

  # ----------------------------------------------------------
  # Main App PostgreSQL
  # ----------------------------------------------------------
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: tire_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin123
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U admin" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------
  # MinIO (S3)
  # ----------------------------------------------------------
  minio:
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: admin123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  # ----------------------------------------------------------
  # Grafana
  # ----------------------------------------------------------
  email-notifier:
    build: ./email-notifier
    container_name: email-notifier
    depends_on:
      - kafka
      - postgres
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - KAFKA_TOPIC=tire.alerts
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=tire_db
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin123
      - SMTP_SERVER=smtp.gmail.com
      - SMTP_PORT=587
      - SMTP_EMAIL=${SMTP_EMAIL:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
    networks:
      - default

  grafana:
    image: grafana/grafana
    ports:
      - "3000:3000"
    depends_on:
      - postgres
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin123
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning

  # ----------------------------------------------------------
  # FastAPI
  # ----------------------------------------------------------
  fastapi:
    build: ./api
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://admin:admin123@postgres:5432/tire_db
      KAFKA_BROKER: kafka:9092
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy

# ----------------------------------------------------------
# Top-Level Volumes
# ----------------------------------------------------------
volumes:
  postgres_data:
  minio_data:
  grafana_data:
  nifi_data:
